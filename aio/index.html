















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2021-10-17 17:53:54 +0000">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
    <link rel="license" href="#license-info" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/swc/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/swc/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/swc/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/swc/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/swc/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/swc/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/swc/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/swc/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/swc/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="Software Carpentry - Introduction to Docker"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/swc/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/swc/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/swc/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/swc/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/swc/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

  <title>
  Introduction to Docker
  </title>  

  </head>
  <body>

    


<div class="panel panel-default life-cycle">
  <div id="life-cycle" class="panel-body beta">
    This lesson is being piloted (Beta version)
  </div>
</div>




    <div class="container">
      
















  
  










<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://software-carpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/swc-icon-blue.svg" alt="Software Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            
            <li><a href="../01-introduction/index.html">Introduction</a></li>
            
            
            <li><a href="../02-pulling-images/index.html">Pulling Images</a></li>
            
            
            <li><a href="../03-running-containers/index.html">Running Containers</a></li>
            
            
            <li><a href="../04-file-io/index.html">File I/O with Containers</a></li>
            
            
            <li><a href="../05-dockerfiles/index.html">Writing Dockerfiles and Building Images</a></li>
            
            
            <li><a href="../06-removal/index.html">Removal of Containers and Images</a></li>
            
            
            <li><a href="../07-coffee-break/index.html">Coffee break</a></li>
            
            
            <li><a href="../08-entry/index.html">Using CMD and ENTRYPOINT in Dockerfiles</a></li>
            
            
            <li><a href="../09-build-with-ci/index.html">Build Docker Images with GitLab CI</a></li>
            
            
            <li><a href="../10-challenge-examples/index.html">Challenge Examples</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/index.html">All in one page (Beta)</a></li>
          </ul>
        </li>
        
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../LICENSE.html">License</a></li>
	
	<li><a href="/edit//aio.md" data-checker-ignore>Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>
















<h1 class="maintitle"><a href="../index.html">Introduction to Docker</a></h1>



<article>

<h1 id="introduction" class="maintitle">Introduction</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 5 min
      <br />
      <strong>Exercises:</strong> 5 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>What are containers?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Understand the basics of images and containers.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h1 id="documentation">Documentation</h1>

<p>The <a href="https://docs.docker.com/get-started">official Docker documentation and tutorial</a> can be found on the
Docker website.
It is quite thorough and useful.
It is an excellent guide that should be routinely visited, but the emphasis of this
introduction is on using Docker, not how Docker itself works.</p>

<p>A note up front, Docker has very similar syntax to Git and Linux, so if you are familiar
with the command line tools for them then most of Docker should seem somewhat natural
(though you should still read the docs!).</p>

<p><a href="https://www.docker.com/"><img src="https://www.docker.com/sites/default/files/social/docker_twitter_share_new.png" alt="Docker logo" /></a></p>

<h1 id="docker-images-and-containers">Docker Images and Containers</h1>

<p>It is still important to know what Docker <em>is</em> and what the components of it <em>are</em>.
Docker images are executables that bundle together all necessary components for an
application or an environment.
<a href="https://www.docker.com/resources/what-container">Docker containers</a> are the runtime instances of images — they
are images with a state and act as native Linux processes.</p>

<p>Importantly, containers share the host machine’s OS system kernel and so don’t require an
OS per application.
As discrete processes containers take up only as much memory as necessary, making them
very lightweight and fast to spin up to run.</p>

<p>It is also worth noting that as images are executables that produce containers, the same image
can create multiple container instances that are running simultaneously as different processes.
If you think about other executables that can be run in multiple processes on your machine this
is perhaps not too surprising.</p>

<p><a href="https://www.docker.com/resources/what-container"><img src="https://www.docker.com/sites/default/files/styles/large/public/container-what-is-container.png" alt="Docker structure" /></a></p>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Images are series of zip files that act as templates for containers.</p>
</li>
    
    <li><p>Containers are runtime instantiation of images — images with state and are native processes.</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="pulling-images" class="maintitle">Pulling Images</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 10 min
      <br />
      <strong>Exercises:</strong> 5 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How are images downloaded?</p>
</li>
	
	<li><p>How are images distinguished?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Pull images from Docker Hub image registry</p>
</li>
	
	<li><p>List local images</p>
</li>
	
	<li><p>Introduce image tags</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h1 id="docker-hub">Docker Hub</h1>

<p>Much like GitHub allows for web hosting and searching for code, the <a href="https://hub.docker.com/">Docker Hub</a>
image registry allows the same for Docker images.
Hosting and building of images is <a href="https://hub.docker.com/billing-plans/">free for public repositories</a> and
allows for downloading images as they are needed.
Additionally, through integrations with GitHub and Bitbucket, Docker Hub repositories can
be linked against Git repositories so that
<a href="https://docs.docker.com/docker-hub/builds/">automated builds of Dockerfiles on Docker Hub</a> will be triggered by
pushes to repositories.</p>

<h1 id="pulling-images">Pulling Images</h1>

<p>To begin with we’re going to <a href="https://docs.docker.com/engine/reference/commandline/pull/">pull</a> down the Docker image we’re going
to be working in for the tutorial</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull matthewfeickert/intro-to-docker
</code></pre></div></div>

<p>and then <a href="https://docs.docker.com/engine/reference/commandline/images/">list the images</a> that we have available to us locally</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker images
</code></pre></div></div>

<p>If you have many images and want to get information on a particular one you can apply a
filter, such as the repository name</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker images matthewfeickert/intro-to-docker
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                        TAG          IMAGE ID        CREATED        SIZE
matthewfeickert/intro-to-docker   latest       9602bb3f01a4    11 hours ago   1.54GB
</code></pre></div></div>

<p>or more explicitly</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker images --filter=reference="matthewfeickert/intro-to-docker"
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                        TAG          IMAGE ID        CREATED        SIZE
matthewfeickert/intro-to-docker   latest       9602bb3f01a4    11 hours ago   1.54GB
</code></pre></div></div>

<p>You can see here that there is the <code class="language-plaintext highlighter-rouge">TAG</code> field associated with the
<code class="language-plaintext highlighter-rouge">matthewfeickert/intro-to-docker</code> image.
Tags are way of further specifying different versions of the same image.
As an example, let’s pull the <code class="language-plaintext highlighter-rouge">bullseye</code> release tag of the
<a href="https://hub.docker.com/_/debian">Debian image</a>.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull debian:bullseye
docker images debian
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bullseye: Pulling from library/debian
&lt;some numbers&gt;: Pull complete
Digest: sha256:&lt;the relevant SHA hash&gt;
Status: Downloaded newer image for debian:bullseye
docker.io/library/debian:bullseye

REPOSITORY   TAG        IMAGE ID       CREATED        SIZE
debian       bullseye   f776cfb21b5e   5 days ago     124MB
</code></pre></div></div>

<p>Additionally, there might be times where the <em>same</em> image has different tags.
For example, we can pull the <code class="language-plaintext highlighter-rouge">bootcamp-2021</code> tag of the <code class="language-plaintext highlighter-rouge">matthewfeickert/intro-to-docker</code>
image, but when we inspect it we see that it is the <strong>same</strong> image as the one we already pulled.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull matthewfeickert/intro-to-docker:bootcamp-2021
docker images matthewfeickert/intro-to-docker
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                        TAG             IMAGE ID       CREATED        SIZE
matthewfeickert/intro-to-docker   bootcamp-2021   64708e04f3a9   11 hours ago   1.57GB
matthewfeickert/intro-to-docker   latest          64708e04f3a9   11 hours ago   1.57GB
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="pulling-python">Pulling Python</h2>

  <p>Pull the image for Python 3.9 and then list all <code class="language-plaintext highlighter-rouge">python</code> images along with
the <code class="language-plaintext highlighter-rouge">matthewfeickert/intro-to-docker</code> image</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull python:3.9
docker images --filter=reference="matthewfeickert/intro-to-docker" --filter=reference="python"
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY                        TAG                 IMAGE ID       CREATED         SIZE
matthewfeickert/intro-to-docker   bootcamp-2021       64708e04f3a9   11 hours ago    1.57GB
matthewfeickert/intro-to-docker   latest              64708e04f3a9   11 hours ago    1.57GB
python                            3.9                 e2d7fd224b9c   4 days ago      912MB
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Pull images with <code class="language-plaintext highlighter-rouge">docker pull</code></p>
</li>
    
    <li><p>List images with <code class="language-plaintext highlighter-rouge">docker images</code></p>
</li>
    
    <li><p>Image tags distinguish releases or version and are appended to the image name with a colon</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="running-containers" class="maintitle">Running Containers</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 15 min
      <br />
      <strong>Exercises:</strong> 5 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How are containers run?</p>
</li>
	
	<li><p>How do you monitor containers?</p>
</li>
	
	<li><p>How are containers exited?</p>
</li>
	
	<li><p>How are containers restarted?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Run containers</p>
</li>
	
	<li><p>Understand container state</p>
</li>
	
	<li><p>Stop and restart containers</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>To use a Docker image as a particular instance on a host machine you <a href="https://docs.docker.com/engine/reference/run/">run</a>
it as a container.
You can run in either a <a href="https://docs.docker.com/engine/reference/run/#detached-vs-foreground">detached or foreground</a> (interactive) mode.</p>

<p>Run the image we pulled as an interactive container</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -ti matthewfeickert/intro-to-docker:latest /bin/bash
</code></pre></div></div>

<p>You are now inside the container in an interactive bash session. Check the file directory</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwd
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/docker/data
</code></pre></div></div>

<p>and check the host to see that you are not in your local host system</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostname
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;generated hostname&gt;
</code></pre></div></div>

<p>Further, check the <code class="language-plaintext highlighter-rouge">os-release</code> to see that you are actually inside a release of Debian
(given the <a href="https://github.com/docker-library/python">Docker Library’s Python image</a> Dockerfile choices)</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /etc/os-release
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PRETTY_NAME="Debian GNU/Linux 11 (bullseye)"
NAME="Debian GNU/Linux"
VERSION_ID="11"
VERSION="11 (bullseye)"
VERSION_CODENAME=bullseye
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"
</code></pre></div></div>

<h2 id="monitoring-containers">Monitoring Containers</h2>

<p>Open up a new terminal tab on the host machine and
<a href="https://docs.docker.com/engine/reference/commandline/ps/">list the containers that are currently running</a></p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker ps
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE         COMMAND             CREATED             STATUS              PORTS               NAMES
&lt;generated id&gt;      &lt;image:tag&gt;   "/bin/bash"         n minutes ago       Up n minutes                            &lt;generated name&gt;
</code></pre></div></div>

<p>Notice that the name of your container is some randomly generated name.
To make the name more helpful, <a href="https://docs.docker.com/engine/reference/commandline/rename/">rename</a> the running container</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rename &lt;CONTAINER ID&gt; my-example
</code></pre></div></div>

<p>and then verify it has been renamed</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker ps
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE         COMMAND             CREATED             STATUS              PORTS               NAMES
&lt;generated id&gt;      &lt;image:tag&gt;   "/bin/bash"         n minutes ago       Up n minutes                            my-example
</code></pre></div></div>

<blockquote class="callout">
  <h2 id="renaming-by-name">Renaming by name</h2>

  <p>You can also identify containers to rename by their current name</p>

  <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rename &lt;NAME&gt; my-example
</code></pre></div>  </div>
</blockquote>

<h1 id="exiting-and-restarting-containers">Exiting and restarting containers</h1>

<p>As a test, create a file in your container by printing the current datetime into a file</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date &gt; test.txt
</code></pre></div></div>

<p>In the container exit at the command line</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>exit
</code></pre></div></div>

<p>You are returned to your shell.
If you list the containers you will notice that none are running</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker ps
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre></div></div>

<p>but you can see all containers that have been run and not removed with</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker ps -a
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE         COMMAND             CREATED            STATUS                     PORTS               NAMES
&lt;generated id&gt;      &lt;image:tag&gt;   "/bin/bash"         n minutes ago      Exited (0) t seconds ago                       my-example
</code></pre></div></div>

<p>To restart your exited Docker container <a href="https://docs.docker.com/engine/reference/commandline/start/">start</a> it again and then
<a href="https://docs.docker.com/engine/reference/commandline/attach/">attach</a> it to your shell</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker start &lt;CONTAINER ID&gt;
docker attach &lt;CONTAINER ID&gt;
</code></pre></div></div>

<blockquote class="callout">
  <h2 id="starting-and-attaching-by-name">Starting and attaching by name</h2>

  <p>You can also start and attach containers by their name</p>

  <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker start &lt;NAME&gt;
docker attach &lt;NAME&gt;
</code></pre></div>  </div>
</blockquote>

<p>Notice that your entry point is still <code class="language-plaintext highlighter-rouge">/home/docker/data</code> and then check that your
<code class="language-plaintext highlighter-rouge">test.txt</code> still exists with the datetime you printed into it</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls *.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>test.txt
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat test.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sun Oct 17 16:51:51 UTC 2021
</code></pre></div></div>

<p>So this shows us that we can exit Docker containers for arbitrary lengths of time and then
return to our working environment inside of them as desired.</p>

<blockquote class="callout">
  <h2 id="clean-up-a-container">Clean up a container</h2>

  <p>If you want a container to be <a href="https://docs.docker.com/engine/reference/run/#clean-up---rm">cleaned up</a> — that is
deleted — after you exit it then run with the <code class="language-plaintext highlighter-rouge">--rm</code> option flag</p>

  <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti &lt;IMAGE&gt; /bin/bash
</code></pre></div>  </div>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Run containers with <code class="language-plaintext highlighter-rouge">docker run</code></p>
</li>
    
    <li><p>Monitor containers with <code class="language-plaintext highlighter-rouge">docker ps</code></p>
</li>
    
    <li><p>Exit interactive sessions just as you would a shell</p>
</li>
    
    <li><p>Restart stopped containers with <code class="language-plaintext highlighter-rouge">docker start</code></p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="file-i-o-with-containers" class="maintitle">File I/O with Containers</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 15 min
      <br />
      <strong>Exercises:</strong> 5 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do containers interact with my local file system?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Better understand I/O with containers</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h1 id="copying">Copying</h1>

<p><a href="https://docs.docker.com/engine/reference/commandline/cp/">Copying</a> files between the local host and Docker containers is possible.
On your local host find a file that you want to transfer to the container and then</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch io_example.txt
# If on Mac may need to do: chmod a+x io_example.txt
echo "This was written on local host" &gt; io_example.txt
docker cp io_example.txt &lt;CONTAINER ID&gt;:/home/docker/data/
</code></pre></div></div>

<p>and then from the container check and modify it in some way</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwd
ls io_example.txt
cat io_example.txt
echo "This was written inside Docker" &gt;&gt; io_example.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/docker/data
io_example.txt
This was written on local host
</code></pre></div></div>

<p>and then on the local host copy the file out of the container</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker cp &lt;CONTAINER ID&gt;:/home/docker/data/io_example.txt .
</code></pre></div></div>

<p>and verify if you want that the file has been modified as you wanted</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat io_example.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>This was written on local host
This was written inside Docker
</code></pre></div></div>

<h1 id="volume-mounting">Volume mounting</h1>

<p>What is more common and arguably <strong>more</strong> useful is to <a href="https://docs.docker.com/storage/volumes/">mount volumes</a> to
containers with the <code class="language-plaintext highlighter-rouge">-v</code> flag.
This allows for direct access to the host file system inside of the container and for
container processes to write directly to the host file system.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -v &lt;path on host&gt;:&lt;path in container&gt; &lt;image&gt;
</code></pre></div></div>

<p>For example, to mount your current working directory on your local machine to the <code class="language-plaintext highlighter-rouge">data</code>
directory in the example container</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti -v $PWD:/home/docker/data matthewfeickert/intro-to-docker:latest
</code></pre></div></div>

<p>From inside the container you can <code class="language-plaintext highlighter-rouge">ls</code> to see the contents of your directory on your local
machine</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ls
</code></pre></div></div>

<p>and yet you are still inside the container</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pwd
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/docker/data
</code></pre></div></div>

<p>You can also see that any files created in this path in the container persist upon exit</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch created_inside.txt
exit
ls *.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>created_inside.txt
</code></pre></div></div>

<p>This I/O allows for Docker images to be used for specific tasks that may be difficult to
do with the tools or software installed on only the local host machine.
For example, debugging problems with software that arise on cross-platform software, or
even just having a specific version of software perform a task (e.g., using Python 2 when
you don’t want it on your machine, or using a specific release of
<a href="https://hub.docker.com/r/matthewfeickert/latex-docker/">TeX Live</a> when you aren’t ready to update your system release).</p>

<blockquote class="challenge">
  <h2 id="flag-choices">Flag choices</h2>

  <p>What will be the result of running the following command?</p>
  <blockquote>
    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -v $PWD:/home/docker/data matthewfeickert/intro-to-docker:latest
</code></pre></div>    </div>
  </blockquote>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <p>Outwardly it would appear that there is no affect!
You are returned to your starting terminal.
However, something <em>did</em> happen.
Look again at the flags: <code class="language-plaintext highlighter-rouge">--rm -v</code> …but no <code class="language-plaintext highlighter-rouge">-ti</code> for interactive.
So the container got spun up by <code class="language-plaintext highlighter-rouge">docker run</code>, wasn’t given any command and
and so executed a Bash shell with <code class="language-plaintext highlighter-rouge">/bin/bash</code>, wasn’t put into an interactive
state and finished, and then cleaned itself up with <code class="language-plaintext highlighter-rouge">--rm</code>.</p>
  </blockquote>
</blockquote>

<h1 id="running-jupyter-from-a-docker-container">Running Jupyter from a Docker Container</h1>

<p>You can run a Jupyter server from inside of your Docker container.
First run a container (with Jupyter installed) while
<a href="https://docs.docker.com/engine/reference/run/#expose-incoming-ports">exposing</a> the container’s internal port <code class="language-plaintext highlighter-rouge">8888</code>
with the <code class="language-plaintext highlighter-rouge">-p</code> flag</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti -p 8888:8888 matthewfeickert/intro-to-docker:latest /bin/bash
</code></pre></div></div>

<p>Then <a href="https://jupyter.readthedocs.io/en/latest/running.html#starting-the-notebook-server">start a Jupyter server</a> with the server listening on all IPs</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter lab --allow-root --no-browser --ip 0.0.0.0
</code></pre></div></div>

<p>though for your convince the example container has been configured with these default
settings so you can just run</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter lab
</code></pre></div></div>

<p>Finally, copy and paste the following with the generated token from the server as
<code class="language-plaintext highlighter-rouge">&lt;token&gt;</code> into your web browser on your local host machine</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8888/?token=&lt;token&gt;
</code></pre></div></div>

<p>You now have access to Jupyter running on your Docker container.</p>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Learn how <code class="language-plaintext highlighter-rouge">docker cp</code> works</p>
</li>
    
    <li><p>Learn about volume mounts</p>
</li>
    
    <li><p>Show port forwarding of applications</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="writing-dockerfiles-and-building-images" class="maintitle">Writing Dockerfiles and Building Images</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br />
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How are Dockerfiles written?</p>
</li>
	
	<li><p>How are Docker images built?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Write simple Dockerfiles</p>
</li>
	
	<li><p>Build a Docker image from a Dockerfile</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>Docker images are built through the Docker engine by reading the instructions from a
<a href="https://docs.docker.com/engine/reference/builder/"><code class="language-plaintext highlighter-rouge">Dockerfile</code></a>.
These text based documents provide the instructions though an API similar to the Linux
operating system commands to execute commands during the build.
The <a href="https://github.com/matthewfeickert/Intro-to-Docker/blob/master/Dockerfile"><code class="language-plaintext highlighter-rouge">Dockerfile</code> for the example image</a> being used is an example of
some simple extensions of the <a href="https://hub.docker.com/_/python">official Python 3.9 Docker image</a>
based on the Debian Bullseye OS (<code class="language-plaintext highlighter-rouge">python:3.9-bullseye</code>).</p>

<p>As a very simple of extending the example image into a new image create a <code class="language-plaintext highlighter-rouge">Dockerfile</code>
on your local machine</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch Dockerfile
</code></pre></div></div>

<p>and then write in it the Docker engine instructions to add <a href="https://packages.debian.org/jessie/cowsay"><code class="language-plaintext highlighter-rouge">cowsay</code></a> and
<a href="https://scikit-learn.org"><code class="language-plaintext highlighter-rouge">scikit-learn</code></a> to the environment</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile
FROM matthewfeickert/intro-to-docker:latest

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -qq -y install cowsay &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/* &amp;&amp; \
    ln -s /usr/games/cowsay /usr/bin/cowsay

RUN python -m pip install --no-cache-dir --quiet scikit-learn

USER docker
</code></pre></div></div>

<blockquote class="callout">
  <h2 id="dockerfile-layers">Dockerfile layers</h2>

  <p>Each <code class="language-plaintext highlighter-rouge">RUN</code> command in a Dockerfile creates a new layer to the Docker image.
In general, each layer should try to do one job and the fewer layers in an image
the easier it is compress. When trying to upload and download images on demand the
smaller the size the better.</p>
</blockquote>

<blockquote class="callout">
  <h2 id="dont-run-as-root">Don’t run as <code class="language-plaintext highlighter-rouge">root</code></h2>

  <p>By default Docker containers will run as <code class="language-plaintext highlighter-rouge">root</code>. This is a bad idea and a security concern.
Instead, setup a default user (like <code class="language-plaintext highlighter-rouge">docker</code> in the example) and if needed give the user
greater privileges.</p>
</blockquote>

<p>Then <a href="https://docs.docker.com/engine/reference/commandline/build/"><code class="language-plaintext highlighter-rouge">build</code></a> an image from the <code class="language-plaintext highlighter-rouge">Dockerfile</code> and tag it with a human
readable name</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build . -f Dockerfile -t extend-example:latest
</code></pre></div></div>

<p>You can now run the image as a container and verify for yourself that your additions exist</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti extend-example:latest /bin/bash
which cowsay
cowsay "Hello from Docker"
pip list | grep scikit
python -c 'import sklearn as sk; print(sk)'
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/cowsay
 ___________________
&lt; Hello from Docker &gt;
 -------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||

scikit-learn        1.0
&lt;module 'sklearn' from '/usr/local/lib/python3.9/site-packages/sklearn/__init__.py'&gt;
</code></pre></div></div>

<blockquote class="callout">
  <h2 id="build-context-matters">Build context matters!</h2>

  <p>In the <code class="language-plaintext highlighter-rouge">docker build</code> command the first argument we passed, <code class="language-plaintext highlighter-rouge">.</code>, was the “build context”.
The build context is the set of files that Docker <code class="language-plaintext highlighter-rouge">build</code> is aware of when it starts the build.
The <code class="language-plaintext highlighter-rouge">.</code> meant that the build context was set to the contents of the current working directory.
Importantly, the <em>entire</em> build context is sent to the Docker daemon at build which means that
<strong>any</strong> and <strong>all files</strong> in the build context will be copied and sent.
Given this, you want to make sure that your build context doesn’t contain any
unnecessary large files, or use a <code class="language-plaintext highlighter-rouge">.dockerignore</code> file to hide them.</p>
</blockquote>

<h1 id="beyond-the-basics">Beyond the basics</h1>

<h2 id="args-and-envs"><code class="language-plaintext highlighter-rouge">ARG</code>s and <code class="language-plaintext highlighter-rouge">ENV</code>s</h2>

<p>Even though the Dockerfile is a set of specific build instructions to the Docker engine it
can still be scripted to give greater flexibility by using the Dockerfile
<a href="https://docs.docker.com/engine/reference/builder/#arg"><code class="language-plaintext highlighter-rouge">ARG</code></a> instruction and the <a href="https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg"><code class="language-plaintext highlighter-rouge">build-arg</code></a> flag to
define build time variables to be evaluated. For example, consider an example Dockerfile
with a configurable <a href="https://docs.docker.com/engine/reference/builder/#from"><code class="language-plaintext highlighter-rouge">FROM</code></a> image</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.arg-py3
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

RUN python -m pip --no-cache-dir install --upgrade pip setuptools wheel &amp;&amp; \
    python -m pip --no-cache-dir install --quiet scikit-learn

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

WORKDIR /home/docker/data
USER docker
</code></pre></div></div>

<p>and then build it using the <code class="language-plaintext highlighter-rouge">python:3.8</code> image as the <code class="language-plaintext highlighter-rouge">FROM</code> image</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.arg-py3 --build-arg BASE_IMAGE=python:3.8 -t arg-example:py-38 .
</code></pre></div></div>

<p>which you can check has Python 3.8 and not Python 3.9</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti arg-example:py-38 /bin/bash
which python
python --version
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/bin/python3

Python 3.8.11
</code></pre></div></div>

<blockquote class="callout">
  <h2 id="default-arg-values">Default <code class="language-plaintext highlighter-rouge">ARG</code> values</h2>

  <p>Setting the value of the <code class="language-plaintext highlighter-rouge">ARG</code> inside of the Dockerfile allows for default values to be
used if no <code class="language-plaintext highlighter-rouge">--build-arg</code> is passed to <code class="language-plaintext highlighter-rouge">docker build</code>.</p>
</blockquote>

<p><a href="https://docs.docker.com/engine/reference/builder/#env"><code class="language-plaintext highlighter-rouge">ENV</code></a> variables are similar to <code class="language-plaintext highlighter-rouge">ARG</code> variables, except that they persist
past the build stage and still accessible in the container runtime.
Think of using <code class="language-plaintext highlighter-rouge">ENV</code> in a similar manner to how you would use <code class="language-plaintext highlighter-rouge">export</code> in Bash.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.arg-py3
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

RUN python -m pip --no-cache-dir install --upgrade pip setuptools wheel &amp;&amp; \
    python -m pip --no-cache-dir install --quiet scikit-learn

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

# Use C.UTF-8 locale to avoid issues with ASCII encoding
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

ENV HOME /home/docker
WORKDIR ${BASE_IMAGE}/data
USER docker
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.arg-py3 --build-arg BASE_IMAGE=python:3.8 -t arg-example:latest .
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti arg-example:latest /bin/bash
echo $HOME
echo $LC_ALL
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/docker

C.UTF-8
</code></pre></div></div>

<p>whereas for</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti arg-example:py-38 /bin/bash
echo $HOME
echo $LC_ALL
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/docker


</code></pre></div></div>

<h2 id="tags">Tags</h2>

<p>In the examples so far the built image has been tagged with a single tag (e.g. <code class="language-plaintext highlighter-rouge">latest</code>).
However, tags are simply arbitrary labels meant to help identify images and images can
have multiple tags.
New tags can be specified in the <code class="language-plaintext highlighter-rouge">docker build</code> command by giving the <code class="language-plaintext highlighter-rouge">-t</code> flag multiple
times or they can be specified after an image is built by using
<a href="https://docs.docker.com/engine/reference/commandline/tag/"><code class="language-plaintext highlighter-rouge">docker tag</code></a>.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag &lt;SOURCE_IMAGE[:TAG]&gt; &lt;TARGET_IMAGE[:TAG]&gt;
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="add-your-own-tag">Add your own tag</h2>

  <p>Using <code class="language-plaintext highlighter-rouge">docker tag</code> add a new tag to the image you built.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker images extend-example
docker tag extend-example:latest extend-example:my-tag
docker images extend-example
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY          TAG                 IMAGE ID            CREATED            SIZE
extend-example      latest              b571a34f63b9        t seconds ago      1.59GB

REPOSITORY          TAG                 IMAGE ID            CREATED            SIZE
extend-example      latest              b571a34f63b9        t seconds ago      1.59GB
extend-example      my-tag              b571a34f63b9        t seconds ago      1.59GB
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="callout">
  <h2 id="tags-are-labels">Tags are labels</h2>

  <p>Note how the image ID didn’t change for the two tags: they are the same object.
Tags are simply convenient human readable labels.</p>
</blockquote>

<h2 id="copy"><code class="language-plaintext highlighter-rouge">COPY</code></h2>

<p>Docker also gives you the ability to copy external files into a Docker image during the
build with the <a href="https://docs.docker.com/engine/reference/builder/#copy"><code class="language-plaintext highlighter-rouge">COPY</code></a> Dockerfile command.
Which allows copying a target file on the from a host file system into the Docker image
file system</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COPY &lt;path on host&gt; &lt;path in Docker image&gt;
</code></pre></div></div>

<p>For example, if there is a file called <code class="language-plaintext highlighter-rouge">requirements.txt</code> in the same directory as
the build is executed from</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch requirements.txt
</code></pre></div></div>

<p>with contents</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat requirements.txt
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scikit-learn==1.0
</code></pre></div></div>

<p>then this could be copied into the Docker image of the previous example during the build
and then used (and then removed as it is no longer needed) with the following</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.arg-py3
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt requirements.txt

RUN python -m pip --no-cache-dir install --upgrade pip setuptools wheel &amp;&amp; \
    python -m pip --no-cache-dir install --requirement requirements.txt &amp;&amp; \
    rm requirements.txt

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

# Use C.UTF-8 locale to avoid issues with ASCII encoding
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

ENV HOME /home/docker
WORKDIR ${BASE_IMAGE}/data
USER docker
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.arg-py3 --build-arg BASE_IMAGE=python:3.8 -t arg-example:latest .
</code></pre></div></div>

<p>For very complex scripts or files that are on some remote, <code class="language-plaintext highlighter-rouge">COPY</code> offers a straightforward
way to bring them into the Docker build.</p>

<blockquote class="challenge">
  <h2 id="using-copy">Using <code class="language-plaintext highlighter-rouge">COPY</code></h2>

  <p>Write a Bash script that installs the <code class="language-plaintext highlighter-rouge">tree</code> utility and then use <code class="language-plaintext highlighter-rouge">COPY</code> to add it to
your Dockerfile and then run it during the build</p>

  <blockquote class="solution">
    <h2 id="solution-1">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch install_tree.sh
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#install_tree.sh</span>
<span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

apt-get update <span class="nt">-y</span>
apt-get <span class="nb">install</span> <span class="nt">-y</span> tree
</code></pre></div>    </div>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.arg-py3
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

COPY requirements.txt requirements.txt

RUN python -m pip --no-cache-dir install --upgrade pip setuptools wheel &amp;&amp; \
    python -m pip --no-cache-dir install --requirement requirements.txt &amp;&amp; \
    rm requirements.txt

COPY install_tree.sh install_tree.sh
RUN bash install_tree.sh &amp;&amp; \
    rm install_tree.sh

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

# Use C.UTF-8 locale to avoid issues with ASCII encoding
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

ENV HOME /home/docker
WORKDIR ${BASE_IMAGE}/data
USER docker
</code></pre></div>    </div>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.arg-py3 --build-arg BASE_IMAGE=python:3.8 -t arg-example:latest .
</code></pre></div>    </div>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti arg-example:latest /bin/bash
cd
which tree
tree
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/bin/tree

.
└── data

1 directory, 0 files
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Dockerfiles are written as text file commands to the Docker engine</p>
</li>
    
    <li><p>Docker images are built with <code class="language-plaintext highlighter-rouge">docker build</code></p>
</li>
    
    <li><p>Built time variables can be defined with <code class="language-plaintext highlighter-rouge">ARG</code> and set with <code class="language-plaintext highlighter-rouge">--build-arg</code></p>
</li>
    
    <li><p><code class="language-plaintext highlighter-rouge">ENV</code> arguments persist into the container runtime</p>
</li>
    
    <li><p>Docker images can have multiple tags associated to them</p>
</li>
    
    <li><p>Docker images can use <code class="language-plaintext highlighter-rouge">COPY</code> to copy files into them during build</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="removal-of-containers-and-images" class="maintitle">Removal of Containers and Images</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 5 min
      <br />
      <strong>Exercises:</strong> 5 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do you cleanup old containers?</p>
</li>
	
	<li><p>How do you delete images?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Learn how to cleanup after Docker</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>You can cleanup/remove a container <a href="https://docs.docker.com/engine/reference/commandline/rm/"><code class="language-plaintext highlighter-rouge">docker rm</code></a></p>
<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rm &lt;CONTAINER ID&gt;
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="remove-old-containers">Remove old containers</h2>

  <p>Start an instance of the tutorial container, exit it, and then remove it with
<code class="language-plaintext highlighter-rouge">docker rm</code></p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run matthewfeickert/intro-to-docker:latest
docker ps -a
docker rm &lt;CONTAINER ID&gt;
docker ps -a
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE         COMMAND             CREATED            STATUS                     PORTS               NAMES
&lt;generated id&gt;      &lt;image:tag&gt;   "/bin/bash"         n seconds ago      Exited (0) t seconds ago                       &lt;name&gt;

&lt;generated id&gt;

CONTAINER ID        IMAGE         COMMAND             CREATED            STATUS                     PORTS               NAMES
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<p>You can remove an image from your computer entirely with <a href="https://docs.docker.com/engine/reference/commandline/rmi/"><code class="language-plaintext highlighter-rouge">docker rmi</code></a></p>
<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rmi &lt;IMAGE ID&gt;
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="remove-an-image">Remove an image</h2>

  <p>Pull down the Python 2.7 image from Docker Hub and then delete it.</p>

  <blockquote class="solution">
    <h2 id="solution-1">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull python:2.7
docker images python
docker rmi &lt;IMAGE ID&gt;
docker images python
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2.7: Pulling from library/python
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
&lt;some numbers&gt;: Pull complete
Digest: sha256:&lt;the relevant SHA hash&gt;
Status: Downloaded newer image for python:2.7
docker.io/library/python:2.7

REPOSITORY   TAG                 IMAGE ID       CREATED         SIZE
python       3.8                 79372a158581   4 days ago      909MB
python       3.9                 e2d7fd224b9c   4 days ago      912MB
python       3.9-bullseye        e2d7fd224b9c   4 days ago      912MB
python       2.7                 68e7be49c28c   18 months ago   902MB

Untagged: python@sha256:&lt;the relevant SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;
Deleted: sha256:&lt;layer SHA hash&gt;

REPOSITORY   TAG                 IMAGE ID       CREATED         SIZE
python       3.8                 79372a158581   4 days ago      909MB
python       3.9                 e2d7fd224b9c   4 days ago      912MB
python       3.9-bullseye        e2d7fd224b9c   4 days ago      912MB
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="callout">
  <h2 id="helpful-cleanup-commands">Helpful cleanup commands</h2>
  <p>What is helpful is to have Docker detect and remove unwanted images and containers for you.
This can be done with <code class="language-plaintext highlighter-rouge">prune</code>, which depending on the context will remove different things.</p>
  <ul>
    <li><a href="https://docs.docker.com/engine/reference/commandline/container_prune/"><code class="language-plaintext highlighter-rouge">docker container prune</code></a> removes all stopped containers, which is helpful to clean up forgotten stopped containers.</li>
    <li><a href="https://docs.docker.com/engine/reference/commandline/image_prune/"><code class="language-plaintext highlighter-rouge">docker image prune</code></a> removes all unused or dangling images (images that do not have a tag). This is helpful for cleaning up after builds.</li>
    <li><a href="https://docs.docker.com/engine/reference/commandline/system_prune/"><code class="language-plaintext highlighter-rouge">docker system prune</code></a> removes all stopped containers, dangling images, and dangling build caches. This is very helpful for cleaning up everything all at once.</li>
  </ul>
</blockquote>

<blockquote class="callout">
  <h2 id="worth-cleaning-up-to-save-disk">Worth cleaning up to save disk</h2>
  <p>Docker images are just lots of compressed archives, and they can take up lots of disk pretty fast.
You can monitor the total disk being used by Docker with <a href="https://docs.docker.com/engine/reference/commandline/system_df/"><code class="language-plaintext highlighter-rouge">df</code></a></p>
  <blockquote>
    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker system df
</code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              n                   0                   X.YGB               X.YGB (100%)
Containers          0                   0                   0B                  0B
Local Volumes       m                   0                   A.BkB               A.BkB (100%)
Build Cache         0                   0                   0B                  0B
</code></pre></div>    </div>
    <p>and for lots of detailed information you can use the <code class="language-plaintext highlighter-rouge">-v</code> verbose flag</p>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker system df -v
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Remove containers with <code class="language-plaintext highlighter-rouge">docker rm</code></p>
</li>
    
    <li><p>Remove images with <code class="language-plaintext highlighter-rouge">docker rmi</code></p>
</li>
    
    <li><p>Perform faster cleanup with <code class="language-plaintext highlighter-rouge">docker container prune</code>, <code class="language-plaintext highlighter-rouge">docker image prune</code>, and <code class="language-plaintext highlighter-rouge">docker system prune</code></p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="coffee-break" class="maintitle">Coffee break</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 0 min
      <br />
      <strong>Exercises:</strong> 15 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>Coffee or tea?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Refresh your mental faculties with coffee and conversation</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p><a href=""><img src="https://i.giphy.com/media/2jd7CRuYayGpW/giphy.webp" alt="coffee" /></a>
<a href="https://github.com/matthewfeickert/talk-IML-workshop-2019/blob/master/figures/Docker_nyan_whale.gif"><img src="https://raw.githubusercontent.com/matthewfeickert/talk-IML-workshop-2019/master/figures/Docker_nyan_whale.gif" alt="nyan-whale" /></a></p>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Breaks are helpful in the service of learning</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="using-cmd-and-entrypoint-in-dockerfiles" class="maintitle">Using CMD and ENTRYPOINT in Dockerfiles</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br />
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How are default commands set in Dockerfiles?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Learn how and when to use <code class="language-plaintext highlighter-rouge">CMD</code></p>
</li>
	
	<li><p>Learn how and when to use <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>So far everytime we’ve run the Docker containers we’ve typed</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti &lt;IMAGE&gt;:&lt;TAG&gt; &lt;command&gt;
</code></pre></div></div>

<p>like</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti python:3.9 /bin/bash
</code></pre></div></div>

<p>Running this dumps us into a Bash session</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>printenv | grep SHELL
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SHELL=/bin/bash
</code></pre></div></div>

<p>However, if no <code class="language-plaintext highlighter-rouge">/bin/bash</code> is given then you are placed inside the Python 3.9 REPL.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti python:3.9
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Python 3.9.7 (default, Oct 13 2021, 09:00:49)
[GCC 10.2.1 20210110] on linux
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt;
</code></pre></div></div>

<p>These are very different behaviors, so let’s understand what is happening.</p>

<p>The Python 3.9 Docker image has a default command that runs when the container is executed,
which is specified in the Dockerfile with <a href="https://docs.docker.com/engine/reference/builder/#cmd"><code class="language-plaintext highlighter-rouge">CMD</code></a>.</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.defaults
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

ENV HOME /home/docker
WORKDIR ${HOME}/data
USER docker

CMD ["/bin/bash"]
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.defaults -t defaults-example:latest --compress .
</code></pre></div></div>

<p>Now running</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti defaults-example:latest
</code></pre></div></div>

<p>again drops you into a Bash shell as specified by <code class="language-plaintext highlighter-rouge">CMD</code>.
As has already been seen, <code class="language-plaintext highlighter-rouge">CMD</code> can be overridden by giving a command after the image</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti defaults-example:latest python
</code></pre></div></div>

<p>The <a href="https://docs.docker.com/engine/reference/builder/#entrypoint"><code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></a> builder command allows to define a command or
commands that are <strong>always</strong> run at the “entry” to the Docker container.
If an <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code> has been defined then <code class="language-plaintext highlighter-rouge">CMD</code> provides optional inputs to the <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># entrypoint.sh</span>
<span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="k">function </span>main<span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-eq</span> 0 <span class="o">]]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">printf</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Hello, World!</span><span class="se">\n</span><span class="s2">"</span>
    <span class="k">else
        </span><span class="nb">printf</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Hello, %s!</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span>
    <span class="k">fi</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

/bin/bash
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Dockerfile.defaults
# Make the base image configurable
ARG BASE_IMAGE=python:3.9-bullseye
FROM ${BASE_IMAGE}

USER root

RUN apt-get -qq -y update &amp;&amp; \
    apt-get -qq -y upgrade &amp;&amp; \
    apt-get -y autoclean &amp;&amp; \
    apt-get -y autoremove &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

# Create user "docker"
RUN useradd -m docker &amp;&amp; \
    cp /root/.bashrc /home/docker/ &amp;&amp; \
    mkdir /home/docker/data &amp;&amp; \
    chown -R --from=root docker /home/docker

ENV HOME /home/docker
WORKDIR ${HOME}/data
USER docker

COPY entrypoint.sh $HOME/entrypoint.sh
ENTRYPOINT ["/bin/bash", "/home/docker/entrypoint.sh"]
CMD ["Docker"]
</code></pre></div></div>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -f Dockerfile.defaults -t defaults-example:latest --compress .
</code></pre></div></div>

<p>So now</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti defaults-example:latest
</code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Hello, Docker!
docker@2a99ffabb512:~/data$
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="applied-entrypoint-and-cmd">Applied <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code> and <code class="language-plaintext highlighter-rouge">CMD</code></h2>

  <p>What will be the output of</p>
  <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti defaults-example:latest $USER
</code></pre></div>  </div>
  <p>and why?</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Hello, &lt;your user name&gt;!
docker@2a99ffabb512:~/data$
</code></pre></div>    </div>
    <p><code class="language-plaintext highlighter-rouge">$USER</code> is evaluated and then overrides the default <code class="language-plaintext highlighter-rouge">CMD</code> to be passed to <code class="language-plaintext highlighter-rouge">entrypoint.sh</code></p>
  </blockquote>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p><code class="language-plaintext highlighter-rouge">CMD</code> provide defaults for an executing container</p>
</li>
    
    <li><p><code class="language-plaintext highlighter-rouge">CMD</code> can provide options for <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></p>
</li>
    
    <li><p><code class="language-plaintext highlighter-rouge">ENTRYPOINT</code> allows you to configure commands that will always run for an executing container</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="build-docker-images-with-gitlab-ci" class="maintitle">Build Docker Images with GitLab CI</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 20 min
      <br />
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How can CI be used to build Docker images?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Build Docker images using GitLab CI</p>
</li>
	
	<li><p>Deploy Docker images to GitLab Registry</p>
</li>
	
	<li><p>Pull Docker images from GitLab Registry</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<p>We know how to build Docker images, but it would be better to be able to build many images
quickly and not on our own computer.
CI can help here.</p>

<p>First, create a new repository in GitLab.
You can call it whatever you like, but as an example we’ll used “build-with-ci-example”.</p>

<blockquote class="challenge">
  <h2 id="clone-the-repo">Clone the repo</h2>

  <p>Clone the repo down to your local machine and navigate into it.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <p>Get the repo URL from the project GitLab webpage</p>
    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone &lt;repo URL&gt;
cd build-with-ci-example
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="challenge">
  <h2 id="add-a-feature-branch">Add a feature branch</h2>

  <p>Add a new feature branch to the repo for adding CI</p>

  <blockquote class="solution">
    <h2 id="solution-1">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout -b feature/add-CI
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="challenge">
  <h2 id="add-a-dockerfile">Add a Dockerfile</h2>

  <p>Add an example Dockerfile that uses <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></p>

  <blockquote class="solution">
    <h2 id="solution-2">Solution</h2>

    <p>Write and commit a <code class="language-plaintext highlighter-rouge">Dockerfile</code> like</p>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Make the base image configurable
ARG BASE_IMAGE=python:3.7
FROM ${BASE_IMAGE}
USER root
RUN apt-get -qq -y update &amp;&amp; \
   apt-get -qq -y upgrade &amp;&amp; \
   apt-get -y autoclean &amp;&amp; \
   apt-get -y autoremove &amp;&amp; \
   rm -rf /var/lib/apt/lists/*
# Create user "docker"
RUN useradd -m docker &amp;&amp; \
   cp /root/.bashrc /home/docker/ &amp;&amp; \
   mkdir /home/docker/data &amp;&amp; \
   chown -R --from=root docker /home/docker
ENV HOME /home/docker
WORKDIR ${HOME}/data
USER docker

COPY entrypoint.sh $HOME/entrypoint.sh
ENTRYPOINT ["/bin/bash", "/home/docker/entrypoint.sh"]
CMD ["Docker"]
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="challenge">
  <h2 id="add-an-entry-point-script">Add an entry point script</h2>

  <p>Write and commit a Bash script to be run as <code class="language-plaintext highlighter-rouge">ENTRYPOINT</code></p>

  <blockquote class="solution">
    <h2 id="solution-3">Solution</h2>

    <p>Make a file named <code class="language-plaintext highlighter-rouge">entrypoint.sh</code> that contains</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="k">function </span>main<span class="o">()</span> <span class="o">{</span>
   <span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-eq</span> 0 <span class="o">]]</span><span class="p">;</span> <span class="k">then
       </span><span class="nb">printf</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Hello, World!</span><span class="se">\n</span><span class="s2">"</span>
   <span class="k">else
       </span><span class="nb">printf</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Hello, %s!</span><span class="se">\n</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span>
   <span class="k">fi</span>
<span class="o">}</span>

main <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

/bin/bash
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<h2 id="required-gitlab-yaml">Required GitLab YAML</h2>

<p>To build images using GitLab CI jobs the <a href="https://docs.gitlab.com/ee/ci/docker/using_kaniko.html">kaniko</a>
tool from Google is used.
Kaniko jobs on CERN’s Enterprise Edition of GitLab expect some “boiler plate” YAML to run
properly</p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- build

.build_template:
stage: build
image:
  # Use CERN version of the Kaniko image
  name: gitlab-registry.cern.ch/ci-tools/docker-image-builder
  entrypoint: [""]
variables:
  DOCKERFILE: &lt;Dockerfile path&gt;
  BUILD_ARG_1: &lt;argument to the Dockerfile&gt;
  TAG: latest
  # Use single quotes to escape colon
  DESTINATION: '${CI_REGISTRY_IMAGE}:${TAG}'
before_script:
  # Prepare Kaniko configuration file
  - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json
script:
  - printenv
  # Build and push the image from the given Dockerfile
  # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
  - /kaniko/executor --context $CI_PROJECT_DIR
    --dockerfile ${DOCKERFILE}
    --build-arg ${BUILD_ARG_1}
    --destination ${DESTINATION}
only:
  # Only build if the generating files change
  changes:
    - ${DOCKERFILE}
    - entrypoint.sh
except:
  - tags
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="python-37-default-build">Python 3.7 default build</h2>

  <p>Revise this to build from the Python 3.7 image for the <code class="language-plaintext highlighter-rouge">Dockerfile</code> just written</p>

  <blockquote class="solution">
    <h2 id="solution-4">Solution</h2>

    <p>Make a file named <code class="language-plaintext highlighter-rouge">entrypoint.sh</code> that contains</p>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stages:
 - build

.build_template:
 stage: build
 image:
   # Use CERN version of the Kaniko image
   name: gitlab-registry.cern.ch/ci-tools/docker-image-builder
   entrypoint: [""]
 variables:
   DOCKERFILE: Dockerfile
   BUILD_ARG_1: BASE_IMAGE=python:3.7
   TAG: latest
   # Use single quotes to escape colon
   DESTINATION: '${CI_REGISTRY_IMAGE}:${TAG}'
 before_script:
   # Prepare Kaniko configuration file
   - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json
 script:
   - printenv
   # Build and push the image from the given Dockerfile
   # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
   - /kaniko/executor --context $CI_PROJECT_DIR
     --dockerfile ${DOCKERFILE}
     --build-arg ${BUILD_ARG_1}
     --destination ${DESTINATION}
 only:
   # Only build if the generating files change
   changes:
     - ${DOCKERFILE}
     - entrypoint.sh
 except:
   - tags
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<p>Let’s now add two types of jobs: validation jobs that run on MRs and deployment jobs that
run on <code class="language-plaintext highlighter-rouge">master</code></p>

<div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stages:
  - build

.build_template:
  stage: build
  image:
    # Use CERN version of the Kaniko image
    name: gitlab-registry.cern.ch/ci-tools/docker-image-builder
    entrypoint: [""]
  variables:
    DOCKERFILE: Dockerfile
    BUILD_ARG_1: BASE_IMAGE=python:3.7
    TAG: latest
    # Use single quotes to escape colon
    DESTINATION: '${CI_REGISTRY_IMAGE}:${TAG}'
  before_script:
    # Prepare Kaniko configuration file
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json
  script:
    - printenv
    # Build and push the image from the given Dockerfile
    # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html#variables-reference for available variables
    - /kaniko/executor --context $CI_PROJECT_DIR
      --dockerfile ${DOCKERFILE}
      --build-arg ${BUILD_ARG_1}
      --destination ${DESTINATION}
  only:
    # Only build if the generating files change
    changes:
      - ${DOCKERFILE}
      - entrypoint.sh
  except:
    - tags

.validate_template:
  extends: .build_template
  except:
    refs:
      - master

.deploy_template:
  extends: .build_template
  only:
    refs:
      - master

# Validation jobs
validate python 3.7:
  extends: .validate_template
  variables:
    TAG: validate-latest

# Deploy jobs
deploy python 3.7:
  extends: .deploy_template
  variables:
    TAG: latest
</code></pre></div></div>

<blockquote class="challenge">
  <h2 id="python-38-jobs">python 3.8 jobs</h2>

  <p>What needs to be added to build python 3.8 images for both validation jobs and deployment
jobs?</p>

  <blockquote class="solution">
    <h2 id="solution-5">Solution</h2>

    <p>Just more jobs that have a different <code class="language-plaintext highlighter-rouge">BASE_IMAGE</code> variable</p>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
# ...
# Same as the above
# ...

# Validation jobs
validate python 3.7:
 extends: .validate_template
 variables:
   TAG: validate-latest

validate python 3.8:
 extends: .validate_template
 variables:
   BUILD_ARG_1: BASE_IMAGE=python:3.8
   TAG: validate-py-3.8

# Deploy jobs
deploy python 3.7:
 extends: .deploy_template
 variables:
   TAG: latest

deploy python 3.8:
 extends: .deploy_template
 variables:
   BUILD_ARG_1: BASE_IMAGE=python:3.8
   TAG: py-3.8
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="challenge">
  <h2 id="run-pipeline-and-build">Run pipeline and build</h2>

  <p>Now add and commit the CI YAML, push it, and make a MR</p>

  <blockquote class="solution">
    <h2 id="solution-6">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add .gitlab-ci.yml
git commit
git push -u origin feature/add-CI
# visit https://gitlab.cern.ch/&lt;your user name here&gt;/build-with-ci-example/merge_requests/new?merge_request%5Bsource_branch%5D=feature%2Fadd-CI
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<p>In the GitLab UI check the pipeline and the validate jobs and see that different Python 3
versions are being run.
Once they finish, merge the MR and then watch the deploy jobs.
When the jobs finish navigate to your GitLab Registry tab in your GitLab project UI and
click on the link named <code class="language-plaintext highlighter-rouge">&lt;user name&gt;/&lt;build-with-ci-example&gt;</code> under <strong>Container Registry</strong>.
Notice there are 4 container tags.
Click on the icon next to the <code class="language-plaintext highlighter-rouge">py-3.8</code> tag to copy its full registry name into your
clipboard.
This can be used to pull the image from your GitLab registry.</p>

<blockquote class="challenge">
  <h2 id="pull-your-image-from-gitlab-registry">Pull your image from GitLab Registry</h2>

  <p>Pull your CI built python 3.8 image using its full registry name and run it!</p>

  <blockquote class="solution">
    <h2 id="solution-7">Solution</h2>

    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull gitlab-registry.cern.ch/&lt;user name&gt;/build-with-ci-example:py-3.8
docker run --rm -ti gitlab-registry.cern.ch/&lt;user name&gt;/build-with-ci-example:py-3.8
python3 --version
</code></pre></div>    </div>
    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python 3.8.9
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<h2 id="summary">Summary</h2>

<ul>
  <li>Wrote Dockerfile</li>
  <li>Wrote GitLab CI YAML</li>
  <li>Built multiple Docker images in parallel with GitLab CI</li>
  <li>Deployed built images to GitLab registry</li>
  <li>Pulled and used built images from GitLab registry</li>
</ul>

<p><a href=""><img src="https://thumbs.gfycat.com/SecondhandSerpentineApisdorsatalaboriosa-size_restricted.gif" alt="awesome" /></a></p>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>CI can be used to build images automatically</p>
</li>
    
  </ul>
</blockquote>

<hr />

<h1 id="challenge-examples" class="maintitle">Challenge Examples</h1>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 0 min
      <br />
      <strong>Exercises:</strong> 20 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How to do a few more things?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>How to run with SSH and not use <code class="language-plaintext highlighter-rouge">cp</code></p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<blockquote class="challenge">
  <h2 id="get-ssh-credentials-in-a-container-without-cp">Get SSH credentials in a container without <code class="language-plaintext highlighter-rouge">cp</code></h2>

  <p>Get SSH credentials inside a container without using <code class="language-plaintext highlighter-rouge">cp</code></p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <p>Mount multiple volumes</p>
    <div class="language-plaintext source highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm -ti \
 -w /home/atlas/Bootcamp \
 -v $PWD:/home/atlas/Bootcamp \
 -v $HOME/.ssh:/home/atlas/.ssh \
 -v $HOME/.gitconfig:/home/atlas/.gitconfig \
 atlas/analysisbase:21.2.85-centos7
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>Containers are extensive</p>
</li>
    
  </ul>
</blockquote>

<hr />


</article>

      
      






<footer>
  <div class="row">
    <div class="col-md-6 license" id="license-info" align="left">
	
	Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2018–2021
	by <a href="https://carpentries.org/">The Carpentries</a>
        <br>
        Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0</a> 2016–2018
	by <a href="https://software-carpentry.org">Software Carpentry Foundation</a>
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	<a href="/edit//aio.md" data-checker-ignore>Edit on GitHub</a>
	
	/
	<a href="/blob//CONTRIBUTING.md" data-checker-ignore>Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION" data-checker-ignore>Cite</a>
	/
	<a href="mailto:matthew.feickert@cern.ch">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
